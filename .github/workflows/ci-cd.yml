name: CI/CD

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint

      - name: Typecheck
        run: pnpm run check-types

      - name: Build
        run: pnpm run build

  changes:
    name: Detect Changed Areas
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'apps/api/**'
              - 'packages/database/**'
              - 'packages/contract/**'
              - '.github/workflows/ci-cd.yml'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
              - 'turbo.json'
            frontend:
              - 'apps/web/**'
              - 'packages/ui/**'
              - 'packages/contract/**'
              - '.github/workflows/ci-cd.yml'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
              - 'turbo.json'

  deploy-render:
    name: Deploy Backend (Render)
    needs: [quality, changes]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.changes.outputs.backend == 'true'
    steps:
      - name: Skip when Render hook is missing
        if: env.RENDER_DEPLOY_HOOK == ''
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: echo "RENDER_DEPLOY_HOOK not set; skipping backend deploy"

      - name: Trigger Render deploy hook
        if: env.RENDER_DEPLOY_HOOK != ''
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: curl -fsS -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"

  deploy-vercel:
    name: Deploy Frontend (Vercel)
    needs: [quality, changes]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.changes.outputs.frontend == 'true'
    steps:
      - name: Skip when Vercel hook is missing
        if: env.VERCEL_DEPLOY_HOOK == ''
        env:
          VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
        run: echo "VERCEL_DEPLOY_HOOK not set; skipping frontend deploy"

      - name: Trigger Vercel deploy hook
        if: env.VERCEL_DEPLOY_HOOK != ''
        env:
          VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
        run: curl -fsS -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
